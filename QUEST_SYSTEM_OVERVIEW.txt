PurgeGame / Degenerus Quest System Overview

Source of truth (code):
- contracts/modules/DegenerusQuestModule.sol
- contracts/interfaces/IDegenerusQuestModule.sol
- contracts/DegenerusCoin.sol
- contracts/modules/DegenerusGameJackpotModule.sol
- contracts/DegenerusGamepieces.sol
- contracts/DegenerusGame.sol
- contracts/DegenerusAffiliate.sol
- contracts/DegenerusBonds.sol

High-level architecture
- The quest system lives in DegenerusQuestModule. It owns daily quest state and per-player quest progress/streaks.
- The quest module is "coin-gated": only DegenerusCoin can call quest entry points.
- DegenerusCoin is the hub: it forwards gameplay events (mints, flips, burns, bonds, affiliate payouts) to the quest module
  and applies the returned quest reward by adding BURNIE credit to coinflips.
- Daily quests are rolled during jackpot processing in DegenerusGameJackpotModule using the VRF entropy already used for jackpots.

Daily quest roll (when and how)
- Two quest slots are active per day (QUEST_SLOT_COUNT = 2).
- The quest day is derived from the same day window used by jackpots:
  questDay = (block.timestamp - JACKPOT_RESET_TIME) / 1 days, where JACKPOT_RESET_TIME = 82620.
- DegenerusGameJackpotModule triggers rolls (via DegenerusCoin):
  - payDailyJackpot (daily or early-burn jackpots) -> rollDailyQuest
  - payCarryoverExterminationJackpot -> rollDailyQuest
  - payMapJackpot -> rollDailyQuestWithOverrides(forceMintEth=true, forceBurn=true)
- Roll randomness uses a single entropy word; slot1 reuses entropy with swapped 128-bit halves.
- Both slots share the same difficulty flags (high/very high) for that day.

Quest types (questType enum)
0 = MINT_BURNIE     (mint with BURNIE)
1 = MINT_ETH        (mint with ETH)
2 = FLIP            (coinflip stake burned)
3 = AFFILIATE       (affiliate earnings credited)
4 = BURN            (NFT burn in game state 3)
5 = DECIMATOR       (BURNIE burn during decimator window)
6 = BOND            (bond purchase size in wei)

Quest selection and gating
- Primary quest type weights (used for slot0):
  - MINT_ETH: 5
  - MINT_BURNIE: 1
  - BURN: 2 (only if gameState == 3)
  - BOND: 2
  - AFFILIATE: 1
  - DECIMATOR: 4 (only if decimator window allowed)
  - FLIP: not weighted as primary (only appears in bonus slot)
- Bonus quest type weights (slot1) pick a different type than primary:
  - Default weight 1 per eligible type
  - DECIMATOR gets weight 4 when enabled
  - BURN gets weight 2 when enabled
- Burn quests are only eligible when gameState == 3.
- Decimator quests are only eligible when the decimator window latch is open (decWindowOpenFlag, independent of RNG lock) and:
  - level % 100 == 0 (and level != 0), or
  - level >= 15, level % 10 == 5, and level % 100 != 95
- Bond quests only progress while bond purchases are open:
  - level 0 -> closed
  - level < 10 -> open while level < 6
  - otherwise open when level % 10 < 5
- On Map jackpot days, quest roll is forced to MINT_ETH + BURN (via rollDailyQuestWithOverrides).

Quest state (storage)
- DailyQuest (per slot): day, questType, flags (difficulty), version, entropy.
- PlayerQuestState (per player): streak, baseStreak (snapshot for the day), lastCompletedDay, lastActiveDay, per-slot
  progress, per-slot version/day markers, and a completion bitmask.
- Progress is reset when the active day changes or when the quest version changes (version bumps are used to invalidate
  mid-day quest mutations).

Progress units by quest type
- MINT_BURNIE / MINT_ETH / BURN: progress in whole NFT units (uint32).
  - For MAP purchases, 4 MAP mints count as 1 quest unit.
- FLIP: progress in BURNIE base units (6 decimals). Credited from depositCoinflip burns.
- DECIMATOR: progress in BURNIE base units. Credited from decimatorBurn burns.
- AFFILIATE: progress in BURNIE base units. Credited from affiliate payout amounts.
- BOND: progress in wei. Credited from per-bond base size (bond purchase amount).

Targets and difficulty
- Difficulty is a 10-bit roll from entropy (entropy & 0x3FF).
- Difficulty flags:
  - High difficulty if difficulty > 500
  - Very high difficulty if difficulty > 750
- Mint/Burn target: 1, 2, or 3 (based on difficulty), capped by tier + 1.
- Flip target: linear between QUEST_MIN_FLIP_STAKE_TOKEN and a tier-specific max (packed table).
- Decimator target: 2x the flip target for the same tier/difficulty.
- Affiliate target: linear between QUEST_MIN_TOKEN and a tier-specific max (packed table).
- Bond target: between 0.5x mintPrice and a tier-specific max up to 1.0x mintPrice at tier 2.

Streaks and tiers
- A "day" is complete only when BOTH quest slots are completed.
- Streak increments by 1 when both slots are completed in the same day.
- Missing a day (no quest completion on a day boundary) resets streak to 0.
- Tier = min(streak / 10, 2) (tiers 0..2).
- baseStreak is captured at the first quest interaction each day; it is used to set requirements for that day.

Rewards (how and where they apply)
- Quest module computes a reward share but does not mint tokens.
- Base per-slot reward is (PRICE_COIN_UNIT / 5) / 2:
  - PRICE_COIN_UNIT is 1000 BURNIE (1e9 base units), so base reward is 100 BURNIE per slot.
- Difficulty bonus:
  - +50 BURNIE if high difficulty and tier > 0
  - +100 BURNIE if very high difficulty and tier == 2
- Tier milestone bonus:
  - +500 BURNIE at 10-streak, +1000 at 20-streak, +1500 at 30-streak (capped after 30).
- DegenerusCoin applies quest rewards by adding the reward amount to coinflip credit:
  - depositCoinflip: reward is added to the stake for that flip day.
  - notifyQuestMint / notifyQuestBond / notifyQuestBurn / affiliateQuestReward: reward is credited as flip stake.
  - decimatorBurn: reward increases the base amount used for decimator weighting.
- DegenerusCoin emits QuestCompleted when a quest completes (reward, type, streak, hardMode flag).

Quest conversions when burn is disallowed
- When extermination ends and burn is no longer allowed, the game calls questModule.normalizeActiveBurnQuests().
- The quest module converts active burn quests to:
  - MINT_ETH if the other slot is not MINT_ETH, or
  - AFFILIATE if the other slot is MINT_ETH.
- Conversion bumps the quest version so any in-progress burn progress resets.
- View functions also present converted burn quests when burn is currently disallowed.

External wiring and access control
- DegenerusQuestModule is constructed with immutable coin and admin addresses.
- Admin wires the DegenerusGame address into the quest module once via wire([game]).
- DegenerusCoin wires the quest module once via wire([game, nft, questModule, jackpots]).
- DegenerusGame holds the quest module address for streak bonuses in playerBonusMultiplier.

Key entry points and call paths
- rollDailyQuest / rollDailyQuestWithOverrides: called by DegenerusGameJackpotModule -> DegenerusCoin -> QuestModule.
- handleMint: called by DegenerusCoin.notifyQuestMint from DegenerusGamepieces purchases.
- handleFlip: called by DegenerusCoin.depositCoinflip.
- handleDecimator: called by DegenerusCoin.decimatorBurn.
- handleBondPurchase: called by DegenerusCoin.notifyQuestBond from DegenerusBonds.
- handleAffiliate: called by DegenerusCoin.affiliateQuestReward from DegenerusAffiliate.
- handleBurn: called by DegenerusCoin.notifyQuestBurn from DegenerusGame burnTokens.

View helpers (for UI / indexing)
- DegenerusCoin.getActiveQuests(): quest info with tier-0 requirements.
- DegenerusCoin.playerQuestStates(): raw streak + progress + completion flags.
- DegenerusCoin.getPlayerQuestView(): player-specific quest view with tier-adjusted requirements and progress.
- QuestInfo.requirements.tokenAmount is BURNIE base units for token quests, or wei for bond quests.
