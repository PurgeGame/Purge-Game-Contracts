import fs from "node:fs";
import path from "node:path";
import { getCreateAddress, isAddress } from "ethers";

const DEPLOY_ORDER = [
  "ICONS_32",
  "TROPHY_SVG_ASSETS",
  "GAME_MINT_MODULE",
  "GAME_JACKPOT_MODULE",
  "GAME_BOND_MODULE",
  "GAME_ENDGAME_MODULE",
  "DGNRS",
  "BONDS",
  "COIN",
  "VAULT",
  "AFFILIATE",
  "JACKPOTS",
  "QUESTS",
  "ICON_COLOR_REGISTRY",
  "RENDERER_REGULAR",
  "RENDERER_TROPHY_SVG",
  "RENDERER_TROPHY",
  "GAMEPIECE_RENDERER_ROUTER",
  "TROPHY_RENDERER_ROUTER",
  "TROPHIES",
  "GAMEPIECES",
  "GAME",
  "ADMIN"
];

const ALL_CONSTANTS = [...DEPLOY_ORDER, "STETH_TOKEN", "LINK_TOKEN", "CREATOR"];

const NETWORK_DEFAULTS = {
  mainnet: {
    STETH_TOKEN: "0xae7ab96520DE3A18E5e111B5EaAb095312D7fE84",
    LINK_TOKEN: "0x514910771AF9Ca656af840dff83E8264EcF986CA"
  },
  sepolia: {
    STETH_TOKEN: "0x3e3FE7dBc6B4C189E7128855dD526361c49b40Af",
    LINK_TOKEN: "0x779877A7B0D9E8603169DdbD7836e478b4624789"
  }
};

const ZERO_ADDRESS = "0x0000000000000000000000000000000000000000";

function parseArgs(argv) {
  const out = {};
  for (let i = 0; i < argv.length; i += 1) {
    const raw = argv[i];
    if (!raw.startsWith("--")) continue;
    const trimmed = raw.slice(2);
    const eqIdx = trimmed.indexOf("=");
    if (eqIdx !== -1) {
      const key = trimmed.slice(0, eqIdx);
      const value = trimmed.slice(eqIdx + 1);
      out[key] = value;
      continue;
    }
    const next = argv[i + 1];
    if (next && !next.startsWith("--")) {
      out[trimmed] = next;
      i += 1;
    } else {
      out[trimmed] = true;
    }
  }
  return out;
}

function requireAddress(label, value) {
  if (!value || typeof value !== "string" || !isAddress(value)) {
    throw new Error(`Invalid ${label} address: ${value}`);
  }
  return value;
}

function parseNonce(value) {
  if (value === undefined) return 0;
  const n = Number.parseInt(value, 10);
  if (!Number.isInteger(n) || n < 0) {
    throw new Error(`Invalid startNonce: ${value}`);
  }
  return n;
}

function renderSolidity(constants) {
  const lines = [
    "// SPDX-License-Identifier: MIT",
    "pragma solidity ^0.8.26;",
    "",
    "// AUTO-GENERATED by scripts/deploy/build-constants.js",
    "// Do not edit by hand; regenerate via the script.",
    "library DeployConstants {"
  ];

  for (const name of ALL_CONSTANTS) {
    const value = constants[name] || ZERO_ADDRESS;
    lines.push(`    address internal constant ${name} = ${value};`);
  }

  lines.push("}");
  lines.push("");
  return lines.join("\n");
}

function main() {
  const args = parseArgs(process.argv.slice(2));
  if (args.help) {
    console.log(
      [
        "Usage:",
        "  node scripts/deploy/build-constants.js --deployer <address> --startNonce <n> [--network sepolia|mainnet]",
        "Options:",
        "  --deployer   Deployer EOA address (required)",
        "  --startNonce Starting nonce for the deployer (default: 0)",
        "  --network    Network preset for STETH/LINK (sepolia|mainnet)",
        "  --steth      Override STETH token address",
        "  --link       Override LINK token address",
        "  --output     Output path (default: contracts/DeployConstants.sol)"
      ].join("\n")
    );
    return;
  }

  const deployer = requireAddress("deployer", args.deployer);
  const startNonce = parseNonce(args.startNonce);
  const output = args.output ? path.resolve(args.output) : path.resolve("contracts/DeployConstants.sol");
  const networkKey = (args.network || "").toLowerCase();
  const defaults = NETWORK_DEFAULTS[networkKey] || {};
  const steth = args.steth || defaults.STETH_TOKEN;
  const link = args.link || defaults.LINK_TOKEN;

  if (!steth || !link) {
    throw new Error("Missing STETH/LINK: provide --network or explicit --steth and --link.");
  }

  const constants = {};
  let nonce = startNonce;
  for (const name of DEPLOY_ORDER) {
    constants[name] = getCreateAddress({ from: deployer, nonce });
    nonce += 1;
  }

  constants.STETH_TOKEN = requireAddress("steth", steth);
  constants.LINK_TOKEN = requireAddress("link", link);
  constants.CREATOR = deployer;

  fs.mkdirSync(path.dirname(output), { recursive: true });
  fs.writeFileSync(output, renderSolidity(constants), "utf8");
  console.log(`Wrote ${output}`);
}

main();
